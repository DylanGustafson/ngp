#!/bin/bash
ngpid=$(pgrep -f "ngp-loop.sh ")

# Check if process is already running and handle stop command
if [ "$ngpid" != "" ]; then
	if [ "$1" == "stop" ]; then
		kill $ngpid
		kill $(pgrep ngp-bin)
		echo "NGP program stopped"
		exit
	fi

	echo "Already running [$ngpid] (use argument 'stop' to stop)"
	exit

elif [ "$1" == "stop" ]; then
    echo "ngp is not running"
    exit
fi

# Make output directory
outdir="./output"
if [ ! -d $outdir ]; then
    mkdir $outdir
fi

# Run 32-bit prime sieve if needed
if [ ! -f primes.dat ]; then
    echo "primes.dat not found, running sieve through 2^32:"
    ./psieve
fi

# Get input from user prompts or from args
if [ "$#" -ne "5" ]; then
    read -p "Starting value      : " var[0]
    read -p "Stopping value      : " var[1]
    read -p "Thread Chunk Size   : " var[2]
    read -p "Write to file every : " var[3]
    read -p "Log file path       : " logfile
else
    var[0]=$1
    var[1]=$2
    var[2]=$3
    var[3]=$4
    logfile=$5
fi

# Convert scientific notation to integers
for i in {0..3}; do
    var[i]=$(python3 -c "print(int(${var[i]}))")
done

# If write size input was zero, just use entire set (write once)
if [[ var[3] -eq 0 ]]; then
    var[3]=$((var[1] - var[0]))
fi

# Dispatch looping shell script via nohup, then print process
nohup "./ngp-loop.sh" ${var[0]} ${var[1]} ${var[2]} ${var[3]} $logfile >> $logfile 2>&1 &
ngpid=$(pgrep -f "ngp-loop.sh ")
echo "[$ngpid]"
